import streamlit as st
import pandas as pd
import plotly.express as px
import io

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©", layout="wide", page_icon="ğŸ“Š")

# --- ØªÙ†Ø³ÙŠÙ‚ CSS Ù…Ø®ØµØµ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„ÙŠØ© ---
st.markdown("""
<style>
    .main {direction: rtl;}
    h1, h2, h3, p, div {text-align: right; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    .stRadio > label {display: none;}
    .stSelectbox > label {display: none;}
    div[data-testid="stExpander"] details summary p {font-size: 1.2rem; font-weight: bold;}
    .metric-card {background-color: #f0f2f6; padding: 20px; border-radius: 10px; text-align: center;}
    div[data-testid="stMarkdownContainer"] ul {list-style-position: inside; padding-right: 20px;}
</style>
""", unsafe_allow_html=True)

# --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±) ---
@st.cache_data
def load_data():
    data = {
        "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£Ù‡Ø¯Ø§Ù": {
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 1: ÙˆØ¶ÙˆØ­ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù": [
                "Ù‡Ù„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¹Ø§Ù… ÙŠØµÙŠØº Ù…Ø§ ÙŠØ³Ø¹Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„ØªØ­Ù‚ÙŠÙ‚Ù‡ Ø¨Ø¯Ù‚Ø©ØŸ",
                "Ù‡Ù„ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ",
                "Ù‡Ù„ ØªØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ù…Ø¹ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ØŸ"
            ],
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 2: Ø´Ù…ÙˆÙ„ÙŠØ© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù": [
                "Ù‡Ù„ ØªØºØ·ÙŠ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© ÙˆØ§Ù„Ù…Ù‡Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙˆØ¬Ø¯Ø§Ù†ÙŠØ©ØŸ"
            ]
        },
        "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù…Ø­ØªÙˆÙ‰": {
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 1: Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰": [
                "Ù‡Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø¯ÙŠØ« ÙˆÙ…ÙˆØ§ÙƒØ¨ Ù„Ù„Ù…Ø³ØªØ¬Ø¯Ø§ØªØŸ",
                "Ù‡Ù„ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø³Ù„ÙŠÙ…ØŸ"
            ],
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 2: ØµØ­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰": [
                "Ø®Ù„Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.",
                "Ø®Ù„Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù„ØºÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©."
            ]
        },
         "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©": {
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 1: ØªÙ†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©": [
                "Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ØªØ´Ø±Ùƒ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†ØŸ",
                "Ù‡Ù„ Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆØ°Ø§Øª Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©ØŸ"
            ]
        },
         "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙÙ†ÙŠ": {
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 1: Ø§Ù„ØªØµÙ…ÙŠÙ…": [
                "Ù‡Ù„ Ø§Ù„ØºÙ„Ø§Ù Ø¬Ø°Ø§Ø¨ ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©ØŸ",
                "Ù‡Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø±ÙŠØ­ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ"
            ]
        },
         "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…": {
            "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± 1: Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³": [
                "Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚Ø¨Ù„ÙŠØ© ÙˆØ¨Ø¹Ø¯ÙŠØ©ØŸ",
                "Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ù„ØªÙ‚ÙŠÙŠÙ… Ø±Ø¶Ø§ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†ØŸ"
            ]
        }
    }
    return data

# --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
st.title("ğŸ“Š Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©")
st.markdown("---")

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©
with st.expander("ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ", expanded=True):
    col1, col2 = st.columns(2)
    with col1:
        prog_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ")
        trainer_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨ / Ø§Ù„Ù…Ø¹Ø¯")
    with col2:
        date = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚ÙŠÙŠÙ…")
        evaluator = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ÙŠÙ…")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
structure = load_data()
scores = {"Ù…ØªØ­Ù‚Ù‚": 2, "Ù…ØªØ­Ù‚Ù‚ Ø¬Ø²Ø¦ÙŠØ§Ù‹": 1, "ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚": 0}
results = []

st.header("ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±")

# Ø¥Ù†Ø´Ø§Ø¡ Tabs Ù„Ù„Ù…Ø¬Ø§Ù„Ø§Øª
tabs = st.tabs(list(structure.keys()))

# Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø±ÙŠØ© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
for i, (domain, standards) in enumerate(structure.items()):
    with tabs[i]:
        st.subheader(domain)
        for standard, criteria_list in standards.items():
            with st.container():
                st.markdown(f"#### ğŸ“Œ {standard}")
                for criterion in criteria_list:
                    # Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙƒÙ‚Ø§Ø¦Ù…Ø©
                    c1, c2, c3 = st.columns([3, 2, 2])
                    with c1:
                        st.write(f"- {criterion}")
                    with c2:
                        key = f"{domain}_{standard}_{criterion}"
                        status = st.radio(
                            "Ø§Ù„Ø­Ø§Ù„Ø©", 
                            ["Ù…ØªØ­Ù‚Ù‚", "Ù…ØªØ­Ù‚Ù‚ Ø¬Ø²Ø¦ÙŠØ§Ù‹", "ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚"], 
                            horizontal=True, 
                            key=key,
                            index=2 
                        )
                    with c3:
                        notes = st.text_input("Ù…Ù„Ø§Ø­Ø¸Ø§Øª", key=f"notes_{key}", placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©...")
                    
                    # Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                    results.append({
                        "Ø§Ù„Ù…Ø¬Ø§Ù„": domain,
                        "Ø§Ù„Ù…Ø¹ÙŠØ§Ø±": standard,
                        "Ø§Ù„Ù…Ø¤Ø´Ø±": criterion,
                        "Ø§Ù„Ù†ØªÙŠØ¬Ø©": status,
                        "Ø§Ù„Ø¯Ø±Ø¬Ø©": scores[status],
                        "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª": notes
                    })
                st.markdown("---")

# --- Ù‚Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± ---
st.header("ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬")

if st.button("Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"):
    if not prog_name:
        st.warning("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£ÙˆÙ„Ø§Ù‹.")
    else:
        df_res = pd.DataFrame(results)
        
        # Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø³Ø¨
        total_score = df_res['Ø§Ù„Ø¯Ø±Ø¬Ø©'].sum()
        max_score = len(df_res) * 2
        percentage = (total_score / max_score) * 100 if max_score > 0 else 0
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© - Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù‚Ù… 3
        c1, c2, c3 = st.columns(3)
        c1.metric("Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø©", f"{percentage:.1f}%")
        c2.metric("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…ØªØ­Ù‚Ù‚Ø©", len(df_res[df_res['Ø§Ù„Ù†ØªÙŠØ¬Ø©']=="Ù…ØªØ­Ù‚Ù‚"]))
        c3.metric("Ù†Ù‚Ø§Ø· ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†", len(df_res[df_res['Ø§Ù„Ù†ØªÙŠØ¬Ø©']!="Ù…ØªØ­Ù‚Ù‚"]))
        
        # Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø³ÙŠØ·
        st.subheader("Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª")
        if not df_res.empty:
            domain_scores = df_res.groupby("Ø§Ù„Ù…Ø¬Ø§Ù„")['Ø§Ù„Ø¯Ø±Ø¬Ø©'].sum().reset_index()
            st.bar_chart(domain_scores.set_index("Ø§Ù„Ù…Ø¬Ø§Ù„"))
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ÙÙ„ØªØ±Ø© Ù„Ù„ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚ ÙÙ‚Ø·)
        st.subheader("âš ï¸ ÙØ±Øµ Ø§Ù„ØªØ­Ø³ÙŠÙ† (Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ØºÙŠØ± Ø§Ù„Ù…ØªØ­Ù‚Ù‚Ø©)")
        improvement_df = df_res[df_res['Ø§Ù„Ù†ØªÙŠØ¬Ø©'] != "Ù…ØªØ­Ù‚Ù‚"][['Ø§Ù„Ù…Ø¬Ø§Ù„', 'Ø§Ù„Ù…Ø¹ÙŠØ§Ø±', 'Ø§Ù„Ù…Ø¤Ø´Ø±', 'Ø§Ù„Ù†ØªÙŠØ¬Ø©', 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª']]
        
        if not improvement_df.empty:
            st.table(improvement_df)
        else:
            st.success("ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ù…ØªØ­Ù‚Ù‚Ø©.")

        # ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        excel_buffer = io.BytesIO()
        with pd.ExcelWriter(excel_buffer, engine='xlsxwriter') as writer:
            df_res.to_excel(writer, index=False, sheet_name='Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ')
            
        st.download_button(
            label="ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Excel)",
            data=excel_buffer.getvalue(),
            file_name=f"Evaluation_Report.xlsx",
            mime="application/vnd.ms-excel"
        )
